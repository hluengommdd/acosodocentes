<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Vista de impresión - OBVQ-R</title>
    <link rel="icon" type="image/png" href="/logo-oficial.png">
    <!-- Versión cache-busted para asegurar últimos estilos en Vercel -->
    <link rel="stylesheet" href="/print-styles/css/print.css?v=3" />
    <style>
      /* Controles de vista (no se muestran en impresión) */
      #printControls{position:fixed;right:18px;top:18px;z-index:9999;display:flex;gap:8px}
      #printControls button{padding:8px 10px;border-radius:4px;border:1px solid #ccc;background:#fff;cursor:pointer}
      @media print{#printControls{display:none!important}}
    </style>
  </head>
  <body>
    <div id="printContent" class="print-document print-shell">
      <p>Cargando documento...</p>
    </div>

    <script>
      const printData = JSON.parse(sessionStorage.getItem('printData') || '{}')

      async function fetchLogoDataUrl(){
        try{
          const path = window.location.pathname
          const basePath = path.endsWith('/') ? path : path.replace(/\/[^\/]*$/, '/')
          const logoUrl = window.location.origin + basePath + 'logo-oficial.png'
          const resp = await fetch(logoUrl,{cache:'no-store'})
          if(!resp.ok) throw new Error('Logo no encontrado')
          const blob = await resp.blob()
          return await new Promise((resolve,reject)=>{
            const reader = new FileReader()
            reader.onload = ()=>resolve(reader.result)
            reader.onerror = reject
            reader.readAsDataURL(blob)
          })
        }catch(e){
          return 'logo-oficial.png'
        }
      }

      function getTiempoColegio(valor){
        const map = {
          'menos_1_anio':'Menos de 1 año',
          '1_2_anios':'Entre 1 y 2 años',
          'mas_2_anios':'Más de 2 años'
        }
        return map[valor]||'No especificado'
      }

      function valorAFrecuencia(valor){
        const valores={ '0':'Nunca','1':'Una o dos veces','2':'Varias veces al mes','3':'Una o más veces a la semana','4':'Varias veces a la semana' }
        return valores[valor]||'No respondido'
      }

      // Sanitiza texto para evitar inyección al usar innerHTML
      function escapeHtml(str){
        if (str === null || str === undefined) return ''
        return String(str).replace(/[&<>"'`=\/]/g, function(s){
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#96;','=':'&#x3D;'} )[s]
        })
      }

      function generarPregunta(num,text,respuesta){
        return `
          <div class="section">
            <h3>PREGUNTA GENERAL</h3>
            <div class="pregunta-item">
              <div class="pregunta-texto">${num}. ${text}</div>
              <div class="respuesta-valor">→ ${valorAFrecuencia(respuesta)}</div>
            </div>
          </div>`
      }

      function generarSeccion(titulo,preguntas,datos){
        let html=`<div class="section"><h3>${titulo}</h3>`
        preguntas.forEach(p=>{
          const respuesta = datos[`pregunta_${p.num}`]
          html += `
            <div class="pregunta-item">
              <div class="pregunta-texto">${p.num}. ${p.text}</div>
              <div class="respuesta-valor">→ ${valorAFrecuencia(respuesta)}</div>
            </div>`
        })
        html += `</div>`
        return html
      }

      ;(async()=>{
        const hasData = Object.keys(printData||{}).length>0
        const example = { curso:'Ej: 6° A', edad:'10', sexo:['Masculino'], tiempo_colegio:'1_2_anios', pregunta_1:'1', espacio_historia:'Texto de ejemplo para previsualizar' }
        const data = hasData?printData:example

        const fechaEmision = new Date().toLocaleDateString('es-CL',{year:'numeric',month:'2-digit',day:'2-digit'})
        const horaEmision = new Date().toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'})

        const logoSrc = (data&&data.logoDataUrl) || printData.logoDataUrl || await fetchLogoDataUrl()

        // Valores sanitizados para inserción en HTML
        const safeCurso = data.curso ? escapeHtml(data.curso) : 'No especificado'
        const safeEdad = data.edad ? escapeHtml(data.edad) : 'No especificada'
        const safeSexo = Array.isArray(data.sexo) && data.sexo.length>0 ? escapeHtml(data.sexo.join(', ')) : 'No especificado'
        const safeTiempo = escapeHtml(getTiempoColegio(data.tiempo_colegio))

        let html = `
          <header class="print-header">
            <div class="header-left">
              <h1 class="print-page-title">CUESTIONARIO DE EXPERIENCIAS EN LA ESCUELA OBVQ-R</h1>
              <div class="print-page-subtitle">Colegio Carmera Romero de Espinoza - MMDD Concepción</div>
              <div class="print-page-date">Fecha de aplicación: ${fechaEmision} | Hora: ${horaEmision}</div>
            </div>
            <div class="header-right">
              <img class="print-header__logo" src="${logoSrc}" alt="Logo" />
            </div>
          </header>
          <div class="print-body">
            <div class="info-section">
              <h3>Información General del Estudiante</h3>
              <div class="info-grid">
                <div><strong>Curso:</strong> ${safeCurso}</div>
                <div><strong>Edad:</strong> ${safeEdad} años</div>
                <div><strong>Sexo:</strong> ${safeSexo}</div>
                <div><strong>Tiempo en el colegio:</strong> ${safeTiempo}</div>
              </div>
            </div>`

        html += generarPregunta(1,'¿Con qué frecuencia has sido acosado en la escuela?',data.pregunta_1)

        html += generarSeccion('SECCIÓN A: INSULTOS Y BURLAS',[
          {num:2,text:'Me han llamado con nombres feos, me han burlado de mí o me han bromeado de forma hiriente'},
          {num:3,text:'Me han dicho que soy poco atractivo, que soy feo o que mi cuerpo no es bonito'},
          {num:4,text:'Me han insultado por mi raza, color de piel o donde vengo'},
          {num:5,text:'Me han insultado por mis creencias religiosas'},
          {num:6,text:'Me han hecho comentarios desagradables sobre mis gustos o mis características'},
          {num:7,text:'Me han hecho bromas sobre mi forma de hablar, mi acento o porque soy de otro país'}
        ],data)

        html += generarSeccion('SECCIÓN B: EXCLUSIÓN Y RECHAZO SOCIAL',[
          {num:8,text:'Me han dejado fuera de sus juegos o actividades a propósito'},
          {num:9,text:'Me han dicho que no puedo jugar con ellos'},
          {num:10,text:'Me han ignorado completamente o no me hablan'},
          {num:11,text:'Me han prohibido a otros que jueguen conmigo o sean mis amigos'},
          {num:12,text:'Otros estudiantes desaparecen o se van cuando llego'},
          {num:13,text:'Me han hablado mal con otros estudiantes para que no quieran estar conmigo'},
          {num:14,text:'Me han excluido de chats de WhatsApp, juegos online o redes sociales'}
        ],data)

        html += generarSeccion('SECCIÓN C: AGRESIÓN FÍSICA',[
          {num:15,text:'Me han golpeado, pateado o empujado'},
          {num:16,text:'Me han jalado del pelo o arañado'},
          {num:17,text:'Me han encerrado en algún lugar'},
          {num:18,text:'Me han aventado cosas (pelotas, piedras, cuadernos, etc.)'}
        ],data)

        html += generarSeccion('SECCIÓN D: DAÑO A PERTENENCIAS',[
          {num:19,text:'Me han robado dinero u otras cosas'},
          {num:20,text:'Me han roto o dañado a propósito mis cosas (mochilas, útiles, ropa, etc.)'},
          {num:21,text:'Me han sacado mis cosas sin permiso o las han dañado'}
        ],data)

        html += generarSeccion('SECCIÓN E: AMENAZAS E INTIMIDACIÓN',[
          {num:22,text:'Me han amenazado o intimidado'},
          {num:23,text:'Me han obligado a hacer cosas que no quería hacer'},
          {num:24,text:'Me han dicho que van a contarles a otros algo malo de mí'}
        ],data)

        html += generarSeccion('SECCIÓN F: ACOSO POR MEDIOS DIGITALES',[
          {num:25,text:'Me han molestado usando celulares (mensajes, fotos, videos)'},
          {num:26,text:'Me han molestado usando internet o redes sociales (Facebook, WhatsApp, TikTok, etc.)'},
          {num:27,text:'Me han enviado mensajes o comentarios desagradables'}
        ],data)

        html += generarSeccion('SECCIÓN G: OTROS TIPOS DE ACOSO',[
          {num:28,text:'Me han tocado de forma desagradable o inapropiada'},
          {num:29,text:'Me han hecho comentarios de naturaleza sexual que me incomodan'},
          {num:30,text:'Me han molestado, excluido o acosado por tener autismo, TDAH, dislexia u otra diferencia en cómo aprendo o me comporto'},
          {num:31,text:'Me han molestado o excluido por venir de otro país, mi acento, o porque soy extranjero/a'},
          {num:32,text:'Me han acosado por mi identidad de género, orientación sexual u otra característica personal'}
        ],data)

        html += `<div class="section"><h3>INFORMACIÓN ADICIONAL</h3>`
        if (data.inicio_acoso) html += `<p><strong>¿Cuándo comenzó el acoso?</strong> ${escapeHtml(data.inicio_acoso)}</p>`
        if (data.grupo_cantidad) html += `<p><strong>Cantidad de molestadores:</strong> ${escapeHtml(data.grupo_cantidad)} estudiantes</p>`
        if (data.grupo_nombres && data.grupo_nombres.trim()) html += `<p><strong>Nombres:</strong></p><div class="text-response">${escapeHtml(data.grupo_nombres).replace(/\n/g,'<br/>')}</div>`
        html += `</div>`

        if (Array.isArray(data.sentimientos) && data.sentimientos.length > 0) {
          html += `<div class="section"><h3>CÓMO SE SIENTE</h3><ul class="lista-items">`
          data.sentimientos.forEach(s => html += `<li>${escapeHtml(s)}</li>`)
          html += `</ul></div>`
        }

        if(data.espacio_historia&&data.espacio_historia.trim()){
          html += `
            <div class="section">
              <h3>ESPACIO PARA CONTAR SU HISTORIA</h3>
              <div class="text-response">${escapeHtml(data.espacio_historia).replace(/\n/g,'<br/>')}</div>
            </div>`
        }

        html += `<footer class="print-footer">Documento confidencial - Para uso interno del Equipo de Convivencia Escolar<br>Generado automáticamente el ${fechaEmision} a las ${horaEmision}</footer>`

        document.getElementById('printContent').innerHTML = html

        const controls = document.createElement('div')
        controls.id = 'printControls'
        controls.innerHTML = `<button id="doPrint" aria-label="Guardar PDF">Guardar PDF</button><button id="doPrintDialog" aria-label="Imprimir">Imprimir</button><button id="closeWindow" aria-label="Cerrar ventana">Cerrar</button>`
        document.body.appendChild(controls)

        document.getElementById('doPrint').addEventListener('click',async()=>{
          const element = document.getElementById('printContent')
          const fecha = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')
          const opt = { margin:[10,10,15,10], filename:`OBVQ-${fecha}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }
          try{
            await html2pdf().set(opt).from(element).save()
          }catch(err){
            console.error('Error generando PDF:',err)
            requestAnimationFrame(()=>window.print())
          }
        })
        document.getElementById('doPrintDialog').addEventListener('click',()=>requestAnimationFrame(()=>window.print()))
        document.getElementById('closeWindow').addEventListener('click',()=>{
          try{
            if (window.opener || window.self !== window.top) {
              window.close()
            } else {
              alert('Esta ventana no puede cerrarse automáticamente. Cierra la pestaña manualmente.')
            }
          }catch(e){
            alert('No fue posible cerrar la ventana automáticamente.')
          }
        })
      })()
    </script>

    <script src="print-styles/js/html2pdf.bundle.min.js"></script>
  </body>
</html>
